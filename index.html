<!DOCTYPE html>
<html lang="pt-br" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infográfico de Procedimentos Odontológicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        html, body {
            overflow: hidden; /* Prevent body scroll */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .filter-panel {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            transform: translateX(0);
            z-index: 40;
        }
        .filter-panel.collapsed {
            transform: translateX(-100%);
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        .main-content-wrapper {
            transition: margin-left 0.3s ease-in-out;
        }
        .budget-panel {
            transition: all 0.3s ease-in-out;
            z-index: 50;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        /* Custom Range Slider Styles */
        .price-slider-container {
            position: relative;
            height: 20px;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .price-slider-track, .price-slider-progress {
            position: absolute;
            height: 4px;
            border-radius: 2px;
            width: 100%;
            left: 0;
        }
        .price-slider-track {
            background-color: #e2e8f0;
        }
        .dark .price-slider-track {
            background-color: #4a5568;
        }
        .price-slider-progress {
            background-color: #3b82f6;
        }
        .price-slider-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            z-index: 2;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="flex h-screen">
        <!-- Painel de Filtros -->
        <aside id="filter-panel" class="filter-panel w-full md:w-80 bg-white dark:bg-gray-800 p-6 shadow-lg flex-shrink-0 fixed md:relative h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-100">Filtros</h2>
                <button id="toggle-filters-btn-inside" class="md:hidden p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- Conteúdo dos filtros aqui -->
            <div class="mb-4">
                <label for="search" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Pesquisar Procedimento</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-400"></i>
                    </span>
                    <input type="text" id="search" placeholder="Nome do procedimento..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>
            <div class="mb-4">
                <label for="sort" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Ordenar por</label>
                <select id="sort" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="alpha">Alfabética (A-Z)</option>
                    <option value="price-asc">Valor (Menor para Maior)</option>
                    <option value="price-desc">Valor (Maior para Menor)</option>
                    <option value="specialty" selected>Especialidade</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="specialty-filter" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Especialidade</label>
                <select id="specialty-filter" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="all">Todas</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Faixa de Valor (R$)</label>
                <div class="price-slider-container" id="price-slider">
                    <div class="price-slider-track"></div>
                    <div class="price-slider-progress" id="price-slider-progress"></div>
                    <div class="price-slider-handle" id="handle-min"></div>
                    <div class="price-slider-handle" id="handle-max"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                    <span id="min-price-label">R$ 0</span>
                    <span id="max-price-label">R$ 15.500</span>
                </div>
            </div>
            <button id="clear-filters-btn" class="w-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                <i class="fas fa-times-circle"></i> Limpar Filtros
            </button>
        </aside>

        <!-- Conteúdo Principal -->
        <div id="main-content-wrapper" class="main-content-wrapper flex-1 flex flex-col overflow-hidden">
            <!-- Cabeçalho Fixo -->
            <header class="flex-shrink-0 p-4 md:px-8 md:pt-6 bg-gray-50 dark:bg-gray-900 z-10 border-b border-gray-200 dark:border-gray-700/50">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button id="toggle-filters-btn-outside" class="p-2 text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-filter"></i>
                        </button>
                        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Procedimentos</h1>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button id="scroll-to-stats-btn" class="p-2 text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-700" title="Ir para Estatísticas">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button id="theme-toggle-btn" class="p-2 text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-700" title="Alternar Tema">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button id="budget-toggle-btn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span class="hidden sm:inline">Orçamento</span>
                            <span id="budget-count" class="bg-white text-blue-600 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Área de Rolagem -->
            <main id="scroll-area" class="flex-grow overflow-y-auto p-4 md:p-8">
                <!-- Lista de Procedimentos -->
                <div id="procedure-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Cards de procedimentos serão inseridos aqui -->
                </div>
                <div id="no-results" class="hidden text-center py-16">
                    <i class="fas fa-search fa-3x text-gray-400 dark:text-gray-500 mb-4"></i>
                    <p class="text-xl text-gray-600 dark:text-gray-300">Nenhum procedimento encontrado.</p>
                    <p class="text-gray-500 dark:text-gray-400">Tente ajustar seus filtros ou termo de pesquisa.</p>
                </div>

                <!-- Seção de Estatísticas -->
                <section id="stats-section" class="mt-12">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Estatísticas</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="font-bold text-lg mb-4 text-gray-700 dark:text-gray-200">Análise de Preços</h3>
                            <select id="stats-specialty-selector" class="w-full p-2 mb-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500">
                                <option value="all">Todas as Especialidades</option>
                            </select>
                            <div id="specialty-stats-display" class="grid grid-cols-3 gap-4 text-center mt-4">
                               <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Mínimo</p>
                                    <p id="stat-min" class="text-xl font-semibold text-green-600 dark:text-green-400">R$ 0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Médio</p>
                                    <p id="stat-avg" class="text-2xl font-bold text-blue-600 dark:text-blue-400">R$ 0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Máximo</p>
                                    <p id="stat-max" class="text-xl font-semibold text-red-600 dark:text-red-400">R$ 0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                             <h3 class="font-bold text-lg mb-4 text-gray-700 dark:text-gray-200">Distribuição de Preços (Histograma)</h3>
                            <div class="chart-container">
                                <canvas id="price-histogram"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Painel de Orçamento -->
    <div id="budget-panel" class="budget-panel fixed top-0 right-0 h-full w-full md:w-96 bg-white dark:bg-gray-800 shadow-2xl transform translate-x-full p-6 flex flex-col">
        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Seu Orçamento</h2>
            <button id="close-budget-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div id="budget-items" class="flex-grow overflow-y-auto pr-2">
             <div id="empty-budget" class="text-center py-16">
                <i class="fas fa-shopping-cart fa-3x text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-500 dark:text-gray-400">Seu orçamento está vazio.</p>
                <p class="text-sm text-gray-400 dark:text-gray-500">Clique em <i class="fas fa-plus-circle text-blue-500"></i> nos procedimentos para adicionar.</p>
            </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
            <div class="flex justify-between items-center text-xl font-bold mb-4">
                <span class="dark:text-gray-200">Total:</span>
                <div class="text-right">
                    <p id="budget-total-brl" class="text-blue-600 dark:text-blue-400">R$ 0</p>
                    <p id="budget-total-usd" class="text-base text-gray-500 dark:text-gray-400">$ 0</p>
                </div>
            </div>
             <button id="clear-budget-btn" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-trash-alt"></i> Limpar Orçamento
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const proceduresData = [
                { name: "Acabamento e polimento- sessão", specialty: "Dentística", valueBRL: 550, valueUSD: 91.74 },
                { name: "Ajuste Oclusal - 2 sessões", specialty: "Dentística", valueBRL: 820, valueUSD: 136.78 },
                { name: "Alinhador", specialty: "Ortodontia", valueBRL: 3550, valueUSD: 592.16 },
                { name: "Aparelho estético fixo (valor do aparelho e instalação)", specialty: "Ortodontia", valueBRL: 3850, valueUSD: 642.20 },
                { name: "Aparelho Extrabucal", specialty: "Cirurgia", valueBRL: 1650, valueUSD: 275.23 },
                { name: "Aparelho extraucal de Thurow", specialty: "Ortodontia", valueBRL: 1650, valueUSD: 275.23 },
                { name: "Aparelho fixo metálico (Autoligado/Baixo atrito SWLF) - valor do aparelho e instalação", specialty: "Ortodontia", valueBRL: 3450, valueUSD: 575.48 },
                { name: "Aparelho fixo metálico (valor do aparelho e instalação)", specialty: "Ortodontia", valueBRL: 3350, valueUSD: 558.80 },
                { name: "Aparelho Removível com alça de Bionator invertida", specialty: "Ortodontia", valueBRL: 1650, valueUSD: 275.23 },
                { name: "Aumento de coroa clínica", specialty: "Cirurgia", valueBRL: 850, valueUSD: 141.79 },
                { name: "Avaliação Cirúrgica para Implante", specialty: "Implantodontia", valueBRL: 450, valueUSD: 75.06 },
                { name: "Bichectomia", specialty: "Cirurgia", valueBRL: 3500, valueUSD: 583.82 },
                { name: "Bioestimulador de colágeno", specialty: "Harmonização Orofacial", valueBRL: 3000, valueUSD: 500.42 },
                { name: "Clareamento a Laser", specialty: "Dentística", valueBRL: 2500, valueUSD: 417.01 },
                { name: "Clareamento Caseiro", specialty: "Dentística", valueBRL: 1500, valueUSD: 250.21 },
                { name: "Clareamento de dente desvitalizado (valor por sessão)", specialty: "Endodontia", valueBRL: 750, valueUSD: 125.10 },
                { name: "Confecção de Modelo de Estudo", specialty: "Radiologia", valueBRL: 150, valueUSD: 25.02 },
                { name: "Consulta de Urgência", specialty: "Clínico Geral", valueBRL: 550, valueUSD: 91.74 },
                { name: "Consulta Inicial", specialty: "Clínico Geral", valueBRL: 450, valueUSD: 75.06 },
                { name: "Coroa de Porcelana sobre Implante", specialty: "Prótese", valueBRL: 3500, valueUSD: 583.82 },
                { name: "Coroa Total Metálica", specialty: "Prótese", valueBRL: 1850, valueUSD: 308.59 },
                { name: "Coroa Veneer", specialty: "Prótese", valueBRL: 2500, valueUSD: 417.01 },
                { name: "Documentação Ortodôntica", specialty: "Radiologia", valueBRL: 650, valueUSD: 108.42 },
                { name: "Enxerto Gengival", specialty: "Periodontia", valueBRL: 2500, valueUSD: 417.01 },
                { name: "Enxerto Ósseo", specialty: "Implantodontia", valueBRL: 4500, valueUSD: 750.63 },
                { name: "Exodontia (extração)", specialty: "Cirurgia", valueBRL: 650, valueUSD: 108.42 },
                { name: "Exodontia de dente decíduo", specialty: "Odontopediatria", valueBRL: 450, valueUSD: 75.06 },
                { name: "Exodontia de Raiz Residual", specialty: "Cirurgia", valueBRL: 550, valueUSD: 91.74 },
                { name: "Exodontia de Siso", specialty: "Cirurgia", valueBRL: 1250, valueUSD: 208.51 },
                { name: "Exodontia Simples", specialty: "Cirurgia", valueBRL: 550, valueUSD: 91.74 },
                { name: "Faceta de Porcelana", specialty: "Dentística", valueBRL: 3500, valueUSD: 583.82 },
                { name: "Faceta em Resina", specialty: "Dentística", valueBRL: 1250, valueUSD: 208.51 },
                { name: "Fios de PDO", specialty: "Harmonização Orofacial", valueBRL: 2500, valueUSD: 417.01 },
                { name: "Frenectomia", specialty: "Cirurgia", valueBRL: 850, valueUSD: 141.79 },
                { name: "Gengivoplastia", specialty: "Periodontia", valueBRL: 850, valueUSD: 141.79 },
                { name: "Implante Dentário", specialty: "Implantodontia", valueBRL: 4500, valueUSD: 750.63 },
                { name: "Lente de Contato Dental", specialty: "Dentística", valueBRL: 3500, valueUSD: 583.82 },
                { name: "Levantamento de seio maxilar", specialty: "Implantodontia", valueBRL: 4500, valueUSD: 750.63 },
                { name: "Manutenção de Aparelho", specialty: "Ortodontia", valueBRL: 350, valueUSD: 58.38 },
                { name: "Mascara Facial de Petit", specialty: "Ortodontia", valueBRL: 1650, valueUSD: 275.23 },
                { name: "Núcleo Metálico Fundido", specialty: "Prótese", valueBRL: 950, valueUSD: 158.47 },
                { name: "Pino de Fibra de Vidro", specialty: "Prótese", valueBRL: 850, valueUSD: 141.79 },
                { name: "Placa de Contenção", specialty: "Ortodontia", valueBRL: 850, valueUSD: 141.79 },
                { name: "Placa de Mordida (Miorrelaxante)", specialty: "Disfunção Temporomandibular", valueBRL: 1500, valueUSD: 250.21 },
                { name: "Preenchimento Labial", specialty: "Harmonização Orofacial", valueBRL: 1500, valueUSD: 250.21 },
                { name: "Preenchimento Malar", specialty: "Harmonização Orofacial", valueBRL: 3000, valueUSD: 500.42 },
                { name: "Preenchimento Mandíbula", specialty: "Harmonização Orofacial", valueBRL: 4500, valueUSD: 750.63 },
                { name: "Preenchimento Mento", specialty: "Harmonização Orofacial", valueBRL: 1500, valueUSD: 250.21 },
                { name: "Preenchimento Olheiras", specialty: "Harmonização Orofacial", valueBRL: 1500, valueUSD: 250.21 },
                { name: "Profilaxia (Limpeza)", specialty: "Prevenção", valueBRL: 450, valueUSD: 75.06 },
                { name: "Prótese Total (Dentadura)", specialty: "Prótese", valueBRL: 3500, valueUSD: 583.82 },
                { name: "Radiografia Panorâmica", specialty: "Radiologia", valueBRL: 250, valueUSD: 41.70 },
                { name: "Radiografia Periapical", specialty: "Radiologia", valueBRL: 80, valueUSD: 13.34 },
                { name: "Raspagem Subgengival (por quadrante)", specialty: "Periodontia", valueBRL: 650, valueUSD: 108.42 },
                { name: "Raspagem Supragengival", specialty: "Periodontia", valueBRL: 450, valueUSD: 75.06 },
                { name: "Remoção de Núcleo", specialty: "Prótese", valueBRL: 550, valueUSD: 91.74 },
                { name: "Restauração em Resina", specialty: "Dentística", valueBRL: 550, valueUSD: 91.74 },
                { name: "Retratamento Endodôntico", specialty: "Endodontia", valueBRL: 2500, valueUSD: 417.01 },
                { name: "Sessão de Laserterapia", specialty: "Laserterapia", valueBRL: 450, valueUSD: 75.06 },
                { name: "Skinbooster", specialty: "Harmonização Orofacial", valueBRL: 1500, valueUSD: 250.21 },
                { name: "Toxina botulínica (botox)", specialty: "Harmonização Orofacial", valueBRL: 1400, valueUSD: 233.53 },
                { name: "Traçado Cefalomérico", specialty: "Radiologia", valueBRL: 30, valueUSD: 5.00 },
                { name: "Tratamento Cirúrgico de Fístula Buco Sinusal/Buco Nasal c/ Retalho", specialty: "Cirurgia", valueBRL: 2500, valueUSD: 417.01 },
                { name: "Tratamento com Alinhador", specialty: "Ortodontia", valueBRL: 15500, valueUSD: 2585.49 },
                { name: "Tratamento de fluorose - microabrasão", specialty: "Periodontia", valueBRL: 550, valueUSD: 91.74 },
                { name: "Tratamento de Gengivite", specialty: "Prevenção", valueBRL: 900, valueUSD: 150.13 },
                { name: "Tratamento de Lesão Cística (enucleação)", specialty: "Cirurgia", valueBRL: 1750, valueUSD: 291.91 },
                { name: "Tratamento de Lesão Cística (marzupialização e enucleação final)", specialty: "Cirurgia", valueBRL: 1950, valueUSD: 325.27 },
                { name: "Tratamento Endodôntico Birradicular", specialty: "Endodontia", valueBRL: 2100, valueUSD: 350.29 },
                { name: "Tratamento Endodôntico de Dente com Rizogênese Incompleta", specialty: "Endodontia", valueBRL: 1300, valueUSD: 216.85 }
            ];

            let procedures = [];
            let budget = [];
            let priceChart = null;
            
            procedures = proceduresData.map(p => ({
                ...p,
                id: p.name.toLowerCase().replace(/[^a-z0-9]/g, '-') + '-' + Math.random().toString(36).substr(2, 9)
            })).filter(p => p.valueBRL > 0);

            const getEl = (id) => document.getElementById(id);

            const procedureList = getEl('procedure-list');
            const searchInput = getEl('search');
            const sortSelect = getEl('sort');
            const specialtyFilter = getEl('specialty-filter');
            const noResultsDiv = getEl('no-results');
            const filterPanel = getEl('filter-panel');
            const mainContentWrapper = getEl('main-content-wrapper');
            const toggleFiltersBtnOutside = getEl('toggle-filters-btn-outside');
            const toggleFiltersBtnInside = getEl('toggle-filters-btn-inside');
            const budgetPanel = getEl('budget-panel');
            const budgetToggleBtn = getEl('budget-toggle-btn');
            const closeBudgetBtn = getEl('close-budget-btn');
            const budgetCount = getEl('budget-count');
            const budgetItemsContainer = getEl('budget-items');
            const budgetTotalBRL = getEl('budget-total-brl');
            const budgetTotalUSD = getEl('budget-total-usd');
            const emptyBudgetDiv = getEl('empty-budget');
            const clearBudgetBtn = getEl('clear-budget-btn');
            const statsSpecialtySelector = getEl('stats-specialty-selector');
            const statMin = getEl('stat-min');
            const statAvg = getEl('stat-avg');
            const statMax = getEl('stat-max');
            const themeToggleButton = getEl('theme-toggle-btn');
            const scrollToStatsButton = getEl('scroll-to-stats-btn');
            const clearFiltersBtn = getEl('clear-filters-btn');

            // --- Price Slider Elements ---
            const priceSlider = getEl('price-slider');
            const handleMin = getEl('handle-min');
            const handleMax = getEl('handle-max');
            const progress = getEl('price-slider-progress');
            const minPriceLabel = getEl('min-price-label');
            const maxPriceLabel = getEl('max-price-label');
            let minPrice = 0, maxPrice = 0, currentMinPrice = 0, currentMaxPrice = 0;

            const formatCurrency = (value) => Math.round(value).toLocaleString('pt-BR');

            function initialize() {
                setupPriceSlider();
                populateSpecialtyFilter();
                setupEventListeners();
                resetFilters();
                checkInitialTheme();
                handleResize();
            }

            function populateSpecialtyFilter() {
                const specialties = [...new Set(procedures.map(p => p.specialty))].sort();
                specialties.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    statsSpecialtySelector.appendChild(option.cloneNode(true));
                    specialtyFilter.appendChild(option);
                });
            }

            function setupEventListeners() {
                searchInput.addEventListener('input', updateDisplay);
                sortSelect.addEventListener('change', updateDisplay);
                specialtyFilter.addEventListener('change', updateDisplay);

                toggleFiltersBtnOutside.addEventListener('click', toggleFilterPanel);
                toggleFiltersBtnInside.addEventListener('click', toggleFilterPanel);
                budgetToggleBtn.addEventListener('click', () => budgetPanel.classList.remove('translate-x-full'));
                closeBudgetBtn.addEventListener('click', () => budgetPanel.classList.add('translate-x-full'));
                clearBudgetBtn.addEventListener('click', clearBudget);
                statsSpecialtySelector.addEventListener('change', updateStats);
                themeToggleButton.addEventListener('click', toggleTheme);
                scrollToStatsButton.addEventListener('click', () => {
                    getEl('stats-section').scrollIntoView({ behavior: 'smooth' });
                });
                clearFiltersBtn.addEventListener('click', resetFilters);
                window.addEventListener('resize', handleResize);
            }

            function setupPriceSlider() {
                minPrice = Math.min(...procedures.map(p => p.valueBRL));
                maxPrice = Math.max(...procedures.map(p => p.valueBRL));
                currentMinPrice = minPrice;
                currentMaxPrice = maxPrice;

                function setupHandle(handle, isMin) {
                    const onMove = (clientX) => {
                        const rect = priceSlider.getBoundingClientRect();
                        let newX = clientX - rect.left;
                        let percent = newX / rect.width;
                        percent = Math.max(0, Math.min(1, percent));

                        const newValue = Math.round(minPrice + percent * (maxPrice - minPrice));

                        if (isMin) {
                            currentMinPrice = Math.min(newValue, currentMaxPrice);
                        } else {
                            currentMaxPrice = Math.max(newValue, currentMinPrice);
                        }
                        updateSliderUI();
                    };

                    const onEnd = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onEnd);
                        document.removeEventListener('touchmove', onTouchMove);
                        document.removeEventListener('touchend', onEnd);
                        updateDisplay();
                    };
                    
                    const onMouseMove = (e) => onMove(e.clientX);
                    const onTouchMove = (e) => onMove(e.touches[0].clientX);

                    handle.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onEnd);
                    });
                    handle.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        document.addEventListener('touchmove', onTouchMove);
                        document.addEventListener('touchend', onEnd);
                    });
                }

                setupHandle(handleMin, true);
                setupHandle(handleMax, false);
                updateSliderUI();
            }
            
            function updateSliderUI() {
                const range = maxPrice - minPrice;
                if(range === 0) return;

                const minPercent = (currentMinPrice - minPrice) / range * 100;
                const maxPercent = (currentMaxPrice - minPrice) / range * 100;

                handleMin.style.left = `calc(${minPercent}% - 8px)`;
                handleMax.style.left = `calc(${maxPercent}% - 8px)`;
                progress.style.left = `${minPercent}%`;
                progress.style.width = `${maxPercent - minPercent}%`;

                minPriceLabel.textContent = `R$ ${formatCurrency(currentMinPrice)}`;
                maxPriceLabel.textContent = `R$ ${formatCurrency(currentMaxPrice)}`;
            }

            function resetFilters() {
                searchInput.value = '';
                sortSelect.value = 'specialty';
                specialtyFilter.value = 'all';
                currentMinPrice = minPrice;
                currentMaxPrice = maxPrice;
                updateSliderUI();
                updateDisplay();
            }

            function updateDisplay() {
                let filteredProcedures = [...procedures];

                const searchTerm = searchInput.value.toLowerCase();
                const selectedSpecialty = specialtyFilter.value;

                filteredProcedures = filteredProcedures.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(searchTerm);
                    const specialtyMatch = selectedSpecialty === 'all' || p.specialty === selectedSpecialty;
                    const priceMatch = p.valueBRL >= currentMinPrice && p.valueBRL <= currentMaxPrice;
                    return nameMatch && specialtyMatch && priceMatch;
                });

                const sortValue = sortSelect.value;
                if (sortValue === 'alpha') filteredProcedures.sort((a, b) => a.name.localeCompare(b.name));
                else if (sortValue === 'price-asc') filteredProcedures.sort((a, b) => a.valueBRL - b.valueBRL);
                else if (sortValue === 'price-desc') filteredProcedures.sort((a, b) => b.valueBRL - a.valueBRL);
                else if (sortValue === 'specialty') filteredProcedures.sort((a, b) => a.specialty.localeCompare(b.specialty));

                renderProcedures(filteredProcedures);
                updateHistogram(filteredProcedures);
            }

            function renderProcedures(procs) {
                procedureList.innerHTML = '';
                noResultsDiv.classList.toggle('hidden', procs.length > 0);
                
                procs.forEach(p => {
                    const isInBudget = budget.some(item => item.id === p.id);
                    const card = document.createElement('div');
                    card.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md hover:shadow-xl dark:hover:shadow-blue-900/50 transition-shadow flex flex-col justify-between';
                    card.innerHTML = `
                        <div>
                            <h3 class="font-bold text-md text-gray-800 dark:text-gray-100">${p.name}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${p.specialty}</p>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <div class="text-left">
                                <p class="font-semibold text-lg text-blue-600 dark:text-blue-400">R$ ${formatCurrency(p.valueBRL)}</p>
                                <p class="text-base font-medium text-gray-500 dark:text-gray-300">$ ${formatCurrency(p.valueUSD)}</p>
                            </div>
                            <button data-id="${p.id}" class="add-to-budget-btn p-2 rounded-full transition ${isInBudget ? 'bg-green-500 text-white' : 'bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800'}">
                                <i class="fas ${isInBudget ? 'fa-check' : 'fa-plus'}"></i>
                            </button>
                        </div>
                    `;
                    procedureList.appendChild(card);
                });

                document.querySelectorAll('.add-to-budget-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => toggleBudgetItem(e.currentTarget.dataset.id));
                });
            }

            function toggleBudgetItem(id) {
                const indexInBudget = budget.findIndex(item => item.id === id);
                if (indexInBudget > -1) budget.splice(indexInBudget, 1);
                else budget.push(procedures.find(p => p.id === id));
                updateBudgetPanel();
                updateDisplay();
            }
            
            function updateBudgetPanel() {
                budgetCount.textContent = budget.length;
                budgetItemsContainer.innerHTML = '';
                emptyBudgetDiv.classList.toggle('hidden', budget.length > 0);
                clearBudgetBtn.disabled = budget.length === 0;

                let totalBRL = 0;
                let totalUSD = 0;

                budget.forEach(p => {
                    totalBRL += p.valueBRL;
                    totalUSD += p.valueUSD;
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center mb-3 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg';
                    item.innerHTML = `
                        <div class="flex-grow pr-2">
                            <p class="text-sm font-medium dark:text-gray-200">${p.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">R$ ${formatCurrency(p.valueBRL)}</p>
                        </div>
                        <button data-id="${p.id}" class="remove-from-budget-btn text-red-500 hover:text-red-700 p-1 rounded-full">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    budgetItemsContainer.appendChild(item);
                });

                budgetTotalBRL.textContent = `R$ ${formatCurrency(totalBRL)}`;
                budgetTotalUSD.textContent = `$ ${formatCurrency(totalUSD)}`;
                
                document.querySelectorAll('.remove-from-budget-btn').forEach(btn => {
                    btn.addEventListener('click', e => toggleBudgetItem(e.currentTarget.dataset.id));
                });
            }

            function clearBudget() {
                budget = [];
                updateBudgetPanel();
                updateDisplay();
            }

            function updateStats() {
                const selectedSpecialty = statsSpecialtySelector.value;
                const dataSet = selectedSpecialty === 'all' 
                    ? procedures 
                    : procedures.filter(p => p.specialty === selectedSpecialty);

                if (dataSet.length > 0) {
                    const values = dataSet.map(p => p.valueBRL);
                    statMin.textContent = `R$ ${formatCurrency(Math.min(...values))}`;
                    statMax.textContent = `R$ ${formatCurrency(Math.max(...values))}`;
                    statAvg.textContent = `R$ ${formatCurrency(values.reduce((a, b) => a + b, 0) / values.length)}`;
                } else {
                    statMin.textContent = 'R$ 0';
                    statAvg.textContent = 'R$ 0';
                    statMax.textContent = 'R$ 0';
                }
            }

            function updateHistogram(data) {
                const ctx = getEl('price-histogram').getContext('2d');
                const prices = data.map(p => p.valueBRL);
                
                if (priceChart) priceChart.destroy();
                if (prices.length === 0) return;

                const maxPrice = Math.max(...prices);
                const binCount = 10;
                const binSize = Math.ceil(maxPrice / binCount);
                const bins = new Array(binCount).fill(0);
                const labels = Array.from({length: binCount}, (_, i) => `R$${formatCurrency(i * binSize)} - ${formatCurrency((i + 1) * binSize)}`);

                prices.forEach(price => {
                    const binIndex = Math.min(Math.floor(price / binSize), binCount - 1);
                    if(binIndex >= 0) bins[binIndex]++;
                });
                
                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#e5e7eb' : '#374151';

                priceChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Nº de Procedimentos', data: bins, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Quantidade', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } },
                            x: { title: { display: true, text: 'Faixa de Preço (R$)', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } }
                        },
                        plugins: { legend: { display: false }, tooltip: { bodyColor: '#fff', titleColor: '#fff' } }
                    }
                });
            }

            function toggleTheme() {
                const html = document.documentElement;
                html.classList.toggle('dark');
                if (html.classList.contains('dark')) {
                    localStorage.setItem('theme', 'dark');
                    themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    localStorage.setItem('theme', 'light');
                    themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                }
                updateDisplay();
            }

            function checkInitialTheme() {
                if (localStorage.getItem('theme') === 'dark' || (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('theme'))) {
                    document.documentElement.classList.add('dark');
                    themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                }
            }

            function toggleFilterPanel() {
                filterPanel.classList.toggle('collapsed');
                if (window.innerWidth >= 768) {
                    mainContentWrapper.style.marginLeft = filterPanel.classList.contains('collapsed') ? '0' : `${filterPanel.offsetWidth}px`;
                }
            }
            
            function handleResize() {
                if (window.innerWidth >= 768) {
                    if(!filterPanel.classList.contains('collapsed')) {
                        mainContentWrapper.style.marginLeft = `${filterPanel.offsetWidth}px`;
                    } else {
                         mainContentWrapper.style.marginLeft = '0';
                    }
                } else {
                    filterPanel.classList.add('collapsed');
                    mainContentWrapper.style.marginLeft = '0';
                }
            }
            
            initialize();
        });
    </script>

</body>
</html>
